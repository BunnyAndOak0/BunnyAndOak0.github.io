<!DOCTYPE html>
<html lang="en">





<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/apple-touch-icon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  <title>Nginx - Hexo</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />
<link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/github-gist.min.css" />


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_fmb4a04yx8h.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_pjno9b9zyxs.css">




<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


<meta name="generator" content="Hexo 4.2.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>BunnyAndOak0</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/">
              <i class="iconfont icon-home-fill"></i>
              Home</a>
          </li>
        
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/archives/">
              <i class="iconfont icon-archive-fill"></i>
              Archives</a>
          </li>
        
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/categories/">
              <i class="iconfont icon-category-fill"></i>
              Categories</a>
          </li>
        
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/tags/">
              <i class="iconfont icon-tags-fill"></i>
              Tags</a>
          </li>
        
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="/about/">
              <i class="iconfont icon-user-fill"></i>
              About</a>
          </li>
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="view intro-2" id="background" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container text-center white-text fadeInUp">
            <span class="h2" id="subtitle">
              
            </span>

            
              
                <div class="mt-3 post-meta">
                  <i class="iconfont icon-date-fill" aria-hidden="true"></i>
                  <time datetime="2020-06-17 17:57">
                    June 17, 2020 pm
                  </time>
                </div>
              

              <div class="mt-1">
                
                  
                  <span class="post-meta mr-2">
                    <i class="iconfont icon-chart"></i>
                    2.9k 字
                  </span>
                

                
                  
                  <span class="post-meta mr-2">
                      <i class="iconfont icon-clock-fill"></i>
                    
                    
                    36
                     分钟
                  </span>
                

                
              </div>
            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <div class="post-content mx-auto" id="post">
            
            <article class="markdown-body">
              <div align='center'><font size='6'>Nginx</font></div>

<h2 id="Nginx简介"><a href="#Nginx简介" class="headerlink" title="Nginx简介"></a>Nginx简介</h2><p>​        Nginx是一个高性能的Http和反向代理服务器，特点是占内存少，并发能力强。</p>
<h2 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h2><ol>
<li><p>正向代理</p>
<p>​        在<strong>客户端（浏览器）配置代理服务器</strong>。通过代理服务器进行互联网的访问。</p>
<p><img src="https://github.com/BunnyAndOak0/IMG/raw/master/images/%E6%AD%A3%E5%90%91%E4%BB%A3%E7%90%86.PNG" srcset="/img/loading.gif" alt=""></p>
</li>
<li><p>反向代理</p>
<p>​        <strong>客户端不需要做任何配置就可以访问</strong>，只需要将请求发送到反向代理服务器，由反向代理服务器选择目标服务器获取数据之后，返回给客户端，此时，反向代理服务器和目标服务器就是一个服务器，暴露的是代理服务器地址，隐藏了真实的服务器ip地址。</p>
<p><img src="https://github.com/BunnyAndOak0/IMG/raw/master/images/%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86.PNG" srcset="/img/loading.gif" alt=""></p>
</li>
</ol>
<h2 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h2><p>​        客户端发送多个请求到服务器，服务器处理请求，有一些可能要与数据库进行交互，服务器处理完毕之后，再将结果返回给客户端。</p>
<p>​        当请求数量很大时，我们可以将原先请求集中到单个服务器上的情况改为将请求分发到多个服务器上，将负载分到不同的服务器上，这也就是负载均衡。 <img src="https://github.com/BunnyAndOak0/IMG/raw/master/images/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1.PNG" srcset="/img/loading.gif" alt=""></p>
<p>增加服务器的数量，然后将请求分发到各个服务器上。</p>
<h2 id="动静分离"><a href="#动静分离" class="headerlink" title="动静分离"></a>动静分离</h2><p>​        为了加快网站的解析速度，可以把动态页面和静态页面由不同的服务器来解析(分开部署)，加快解析速度，降低原来单个服务器的压力。</p>
<p><img src="https://github.com/BunnyAndOak0/IMG/raw/master/images/%E5%8A%A8%E9%9D%99%E5%88%86%E7%A6%BB.PNG" srcset="/img/loading.gif" alt=""></p>
<h2 id="Nginx安装"><a href="#Nginx安装" class="headerlink" title="Nginx安装"></a>Nginx安装</h2><p>在linux上安装</p>
<p>命令：</p>
<ol>
<li><p>先下载nginx软件</p>
</li>
<li><p>需要的素材</p>
<p><img src="https://github.com/BunnyAndOak0/IMG/raw/master/images/%E9%9C%80%E8%A6%81%E7%B4%A0%E6%9D%90.PNG" srcset="/img/loading.gif" alt=""></p>
</li>
<li><p>安装依赖</p>
<ul>
<li>安装pcre依赖</li>
</ul>
<p>进入 /usr/src目录下，并解压</p>
<pre><code class="hljs java">tar -xvf pcre-<span class="hljs-number">8.37</span>.tar.gz</code></pre>

<p>TIps：-x 解压     -v：显示详情    -f：指定解压文件    </p>
<p>进入解压之后的目录，执行./configur</p>
<p>使用</p>
<pre><code class="hljs java">make &amp;&amp; make install		<span class="hljs-comment">//进行安装</span>
    <span class="hljs-comment">//可以使用命令  pre-config--version查看版本号</span>
yum -y install gcc-c++		<span class="hljs-comment">//make后出现未指明目录的话需要安装</span></code></pre>

<ul>
<li><p>安装zlib命令</p>
<pre><code class="hljs java">yum -y install make zlib zlib-devel gcc-c++ libtool  openssl openssl-devel 
<span class="hljs-comment">//可以一键安装四个依赖</span></code></pre>
</li>
</ul>
</li>
<li><p>安装nginx</p>
<ul>
<li>步骤同上，回到/usr/src目录下</li>
<li>解压问价</li>
<li>./configure</li>
<li>make &amp;&amp; make install 进行安装</li>
</ul>
</li>
</ol>
<p>安装成功后，在usr中会出现local/nginx，在nginx中，由sbin启动的脚本</p>
<p>进入</p>
<pre><code class="hljs java">[root@localhost /]# cd usr/local/nginx/sbin</code></pre>

<p>启动Nginx：</p>
<pre><code class="hljs java">/nginx</code></pre>

<p>关于防火墙</p>
<blockquote>
<p>查看防火墙状态 systemctl status firewalld<br>开启防火墙 systemctl start firewalld<br>关闭防火墙 systemctl stop firewalld<br>开启防火墙 service firewalld start<br>若遇到无法开启<br>先用：systemctl unmask firewalld.service<br>然后：systemctl start firewalld.service</p>
<p>开启端口：firewall-cmd –zone=public –add-port=8080/tcp –permanent</p>
<p>重新载入配置：firewall-cmd –reload</p>
<p>查看开放的端口号 firewall-cmd –list-all </p>
</blockquote>
<h2 id="Nginx常用命令"><a href="#Nginx常用命令" class="headerlink" title="Nginx常用命令"></a>Nginx常用命令</h2><p>使用nginx命令，必须先进入nginx的目录中，也就是</p>
<pre><code class="hljs java">cd /usr/local/nginx/sbin</code></pre>

<p>查看nginx版本号</p>
<pre><code class="hljs java">./nginx -v</code></pre>

<p>nginx当前状态</p>
<pre><code class="hljs java">ps -ef | grep nginx</code></pre>

<p>启动nginx</p>
<pre><code class="hljs java">./nginx</code></pre>

<p>关闭nginx</p>
<pre><code class="hljs java">./nginx -s stop</code></pre>

<p>重新加载nginx</p>
<pre><code class="hljs java">./nginx -s reload		<span class="hljs-comment">//不需要重启就可以加载配置文件</span>
/usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/nginx.conf		<span class="hljs-comment">//如果有错误，可以使用这个修复</span></code></pre>



<h2 id="Nginx的配置文件"><a href="#Nginx的配置文件" class="headerlink" title="Nginx的配置文件"></a>Nginx的配置文件</h2><ol>
<li><p>Nginx的配置文件目录</p>
<pre><code class="hljs java">[root@localhost /]# cd usr/local/nginx/conf/</code></pre>

<p>中的nginx.conf</p>
</li>
<li><p>配置文件组成</p>
<p>由三部分组成</p>
<ol>
<li><p>全局块</p>
<p>设置一些会影响nginx服务器整体运行的配置指令</p>
<p>例如：</p>
<pre><code class="hljs java">worker_processes  <span class="hljs-number">1</span>;</code></pre>

<p>nginx服务器并发处理的关键配置，worker_processes值越大，可以支持的并发处理量也就越多，但是会受硬件和软件的限制</p>
</li>
</ol>
</li>
</ol>
<ol start="2">
<li><p>events块</p>
<p>涉及的指令主要影响nginx服务器与用户的网络连接</p>
<p>例如：</p>
<pre><code class="hljs java">events &#123;
    worker_connections  <span class="hljs-number">1024</span>;
&#125;</code></pre>

<p>表示nginx支持的连接数，对性能影响很大，应该灵活分配</p>
</li>
</ol>
<ol start="3">
<li><p>http块</p>
<p>配置最频繁的部分，包含了http全局块和server块</p>
<ol>
<li><p>http全局块</p>
<p>包含文件引入、MIME-TYPE定义、日志自定义、连接超时时间等等</p>
<pre><code class="hljs java">include       mime.types;
    default_type  application/octet-stream;
		......</code></pre>
</li>
<li><p>server块</p>
<p>和虚拟主机有密切的关系</p>
<ol>
<li><p>全局server块</p>
<p>监听配置和本虚拟主机的名称或者IP配置</p>
</li>
<li><p>location块</p>
<p>基于nginx进行请求的重定向等等</p>
</li>
</ol>
</li>
</ol>
</li>
</ol>
<h2 id="实例：反向代理"><a href="#实例：反向代理" class="headerlink" title="实例：反向代理"></a>实例：反向代理</h2><p>效果：地址栏输入<a href="http://www.123.com跳转到liunx系统的tomcat主页" target="_blank" rel="noopener">www.123.com跳转到liunx系统的tomcat主页</a></p>
<ol>
<li><p>在linux中安装tomcat的服务器，使用默认端口8080</p>
<p>tomcat 安装文件放到 liunx 系统中，解压</p>
<p>进入 tomcat 的 bin 目录中，./startup.sh 启动 tomcat 服务器 </p>
<blockquote>
<p>tail -f catalina.out                //查看启动日志</p>
</blockquote>
</li>
<li><p>开放访问的端口</p>
</li>
<li><p>windows系统中访问tomcat服务器</p>
</li>
<li><p>具体配置（参看）</p>
<ol>
<li><p>在 windows 系统的 host 文件进行域名和 ip 对应关系的配置 </p>
<pre><code class="hljs java"><span class="hljs-comment">//C:\Windows\System32\drivers\etc中的hosts文件添加对应ip</span>
<span class="hljs-number">192.168</span><span class="hljs-number">.56</span><span class="hljs-number">.101</span> www<span class="hljs-number">.123</span>.com</code></pre>
</li>
<li><p>在 nginx 进行请求转发的配置（反向代理配置） </p>
<pre><code class="hljs java">server &#123;
        listen       <span class="hljs-number">80</span>;
    	<span class="hljs-comment">//配置server_name</span>
        server_name  <span class="hljs-number">192.168</span><span class="hljs-number">.56</span><span class="hljs-number">.101</span>;

        #charset koi8-r;

        #access_log  logs/host.access.log  main;

        location / &#123;
            root   html;
     		<span class="hljs-comment">//添加proxy_pass http</span>
            proxy_pass http:<span class="hljs-comment">//127.0.0.1:8080;</span>
            index  index.html index.htm;
        &#125;</code></pre>


</li>
</ol>
</li>
</ol>
<p>实例2：</p>
<pre><code class="hljs java">server &#123;
        listen       <span class="hljs-number">9001</span>;
    #    listen       somename:8080;
        server_name <span class="hljs-number">192.168</span><span class="hljs-number">.56</span><span class="hljs-number">.101</span> ;

        location ~ /edu/ &#123;
            proxy_pass http:<span class="hljs-comment">//127.0.0.1:8080;</span>
        &#125;
        location ~ /vod/ &#123;
            proxy_pass http:<span class="hljs-comment">//127.0.0.1:8081;</span>
        &#125;
    &#125;</code></pre>

<p>在location中</p>
<pre><code class="hljs java">location [= | ~ | ~* | ^~] uri&#123;
    
&#125;</code></pre>

<p>说明：</p>
<p> 1、= ：用于不含正则表达式的 uri 前，要求请求字符串与 uri 严格匹配，如果匹配 成功，就停止继续向下搜索并立即处理该请求。<br>  2、<del>：用于表示 uri 包含正则表达式，并且区分大小写。<br>  3、`</del><em>`：用于表示 uri 包含正则表达式，并且不区分大小写。<br>  4、^~：用于不含正则表达式的 uri 前，要求 Nginx 服务器找到标识 uri 和请求字 符串匹配度最高的 location 后，立即使用此 location 处理请求，而不再使用 location 块中的正则 uri 和请求字符串做匹配。<br>  注意：如果 uri 包含正则表达式，则必须要有 ~ 或者 ~</em> 标识。 </p>
<h2 id="实例：负载均衡"><a href="#实例：负载均衡" class="headerlink" title="实例：负载均衡"></a>实例：负载均衡</h2><p>实现效果：</p>
<p>浏览器中输入地址，负载均衡效果，将请求平均分配到8080和8081端口中</p>
<ol>
<li><p>准备两台服务器，一台8080，一台8081</p>
</li>
<li><p>两台tomcat都在在webapps中创建文件edu夹，放入相应的页面</p>
</li>
<li><p>nginx的配置文件中进行负载均衡的配置</p>
<pre><code class="hljs java">upstream myserver &#123;
      <span class="hljs-comment">//加上服务器列表</span>
      server <span class="hljs-number">192.168</span><span class="hljs-number">.56</span><span class="hljs-number">.101</span>:<span class="hljs-number">8080</span>;
      server <span class="hljs-number">192.168</span><span class="hljs-number">.56</span><span class="hljs-number">.101</span>:<span class="hljs-number">8081</span>;
   &#125;
   
   server &#123;
       listen       <span class="hljs-number">80</span>;
       server_name  <span class="hljs-number">192.168</span><span class="hljs-number">.56</span><span class="hljs-number">.101</span>;
       location / &#123;
           root   html;
           proxy_pass http:<span class="hljs-comment">//myserver;</span>
           index  index.html index.htm;
       &#125;
   &#125;</code></pre>

</li>
</ol>
<p>分配策略：</p>
<ol>
<li><p>轮询（默认）</p>
<p>每个请求安装时间顺序逐一分配到不同的后端服务器，如果后端服务器down掉，就能自动剔除</p>
</li>
<li><p>wight</p>
<p>weight代表权重，默认为1，权重越高，被分配的用户也就越多，</p>
<p>weight和访问比率成正比，可用于后端服务器性能不均的情况。</p>
</li>
</ol>
<p>例如：</p>
<pre><code class="hljs java">upstream server_pool&#123;    
    server <span class="hljs-number">192.168</span><span class="hljs-number">.5</span><span class="hljs-number">.21</span> weight=<span class="hljs-number">10</span>;     
    server <span class="hljs-number">192.168</span><span class="hljs-number">.5</span><span class="hljs-number">.22</span> weight=<span class="hljs-number">10</span>;     
&#125;</code></pre>

<ol start="3">
<li><p>ip_hash</p>
<p>每个请求按照访问的ip的hash的结果分配，这样每一个访客固定一个后端服务器，可以解决session共享的问题，不能加weight</p>
<p>例如：</p>
<pre><code class="hljs java">upstream server_pool&#123;    
    ip_hash;     
    server <span class="hljs-number">192.168</span><span class="hljs-number">.5</span><span class="hljs-number">.21</span>:<span class="hljs-number">80</span>;     
    server <span class="hljs-number">192.168</span><span class="hljs-number">.5</span><span class="hljs-number">.22</span>:<span class="hljs-number">80</span>;     
&#125;</code></pre>
</li>
<li><p>fair(第三方)</p>
<p>按照后端服务器的响应时间来分配请求，响应时间短的优先分配</p>
<pre><code class="hljs java">upstream server_pool&#123;    
    server <span class="hljs-number">192.168</span><span class="hljs-number">.5</span><span class="hljs-number">.21</span>:<span class="hljs-number">80</span>;     
    server <span class="hljs-number">192.168</span><span class="hljs-number">.5</span><span class="hljs-number">.22</span>:<span class="hljs-number">80</span>;     
    fair;     
&#125;</code></pre>




</li>
</ol>
<h2 id="实例：动静分离"><a href="#实例：动静分离" class="headerlink" title="实例：动静分离"></a>实例：动静分离</h2><p>​        严格意义上来说，就是把动态请求和静态请求分开，可以理解为使用Nginx处理静态页面，Tomcat处理动态页面。</p>
<p><img src="https://github.com/BunnyAndOak0/IMG/raw/master/images/Nginx/%E5%8A%A8%E9%9D%99%E5%88%86%E7%A6%BB.PNG" srcset="/img/loading.gif" alt="动静分离"></p>
<p>有两种方案实现：</p>
<ol>
<li>一种是纯粹把静态文件独立成单独的域名，放在独立的服务器上，也是目前主流推崇的方案。</li>
<li>另外一种方法就是动态跟静态文件混合在一起发布，通过 nginx 来分开。 </li>
</ol>
<p>实现：</p>
<ol>
<li><p>在liunx系统中准备一些静态资源</p>
<p><img src="https://github.com/BunnyAndOak0/IMG/raw/master/images/Nginx/nginx%E8%B5%84%E6%BA%90.PNG" srcset="/img/loading.gif" alt="nginx资源"></p>
</li>
<li><p>在ngxin.conf文件中进行配置</p>
<pre><code class="hljs java">server &#123;
        listen       <span class="hljs-number">80</span>;
        server_name  <span class="hljs-number">192.168</span><span class="hljs-number">.56</span><span class="hljs-number">.101</span>;

        location /www/ &#123;
            root   /data/;
            index  index.html index.htm;
        &#125;
        location /image/&#123;
            root /data/;
            autoindex on;
        &#125;
    &#125;</code></pre>



</li>
</ol>
<h2 id="配置高可用的集群"><a href="#配置高可用的集群" class="headerlink" title="配置高可用的集群"></a>配置高可用的集群</h2><p><img src="https://github.com/BunnyAndOak0/IMG/raw/master/images/Nginx/%E9%AB%98%E5%8F%AF%E7%94%A8.PNG" srcset="/img/loading.gif" alt="高可用"></p>
<p>​        保证在宕机的情况下，服务器仍然可以正常运行，使用一个虚拟的ip与两台服务器进行绑定，并对外开放，keepalived的作用是相当于一个路由器。</p>
<ol>
<li><p>准备两台虚拟机</p>
</li>
<li><p>两台服务器都安装nginx，以及相关配置</p>
</li>
<li><p>安装keepalived</p>
<ul>
<li><p>下载安装包解压安装</p>
</li>
<li><p>用yum命令</p>
<pre><code class="hljs java">yum install keepalived -y
rpm -q -a keepalived		<span class="hljs-comment">//查看版本</span></code></pre>

</li>
</ul>
<p>其安装位置在：<code>[root@localhost /]# cd etc/keepalived/</code></p>
<p>其中：<code>keepalived.conf</code>是配置文件</p>
<p>修改其中配置</p>
<pre><code class="hljs java">global_defs &#123;
 notification_email &#123;
	 acassen<span class="hljs-meta">@firewall</span>.loc
	 failover<span class="hljs-meta">@firewall</span>.loc
	 sysadmin<span class="hljs-meta">@firewall</span>.loc
 &#125;
 notification_email_from Alexandre.Cassen<span class="hljs-meta">@firewall</span>.loc
 smtp_server <span class="hljs-number">192.168</span><span class="hljs-number">.17</span><span class="hljs-number">.129</span>
 smtp_connect_timeout <span class="hljs-number">30</span>
 router_id LVS_DEVEL
&#125;
vrrp_script chk_http_port &#123;
 script <span class="hljs-string">"/usr/local/src/nginx_check.sh"</span>
 interval 2 #（检测脚本执行的间隔）
 weight <span class="hljs-number">2</span>
&#125;
vrrp_instance VI_1 &#123;
 state BACKUP # 备份服务器上将 MASTER 改为 BACKUP
 <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">ens33</span> //网卡  根据自己的网卡配置</span>
<span class="hljs-class"> <span class="hljs-title">virtual_router_id</span> 51 # 主、备机的 <span class="hljs-title">virtual_router_id</span> 必须相同</span>
<span class="hljs-class"> <span class="hljs-title">priority</span> 90 # 主、备机取不同的优先级，主机值较大，备份机值较小</span>
<span class="hljs-class"> <span class="hljs-title">advert_int</span> 1</span>
<span class="hljs-class">  <span class="hljs-title">authentication</span> </span>&#123;
 auth_type PASS
 auth_pass <span class="hljs-number">1111</span>
 &#125;
 virtual_ipaddress &#123;
 <span class="hljs-number">192.168</span><span class="hljs-number">.17</span><span class="hljs-number">.50</span> <span class="hljs-comment">// VRRP H 虚拟地址</span>
 &#125;
&#125;</code></pre>

<p>脚本文件script “/usr/local/src/nginx_check.sh”           注意路径，用于检测nginx是否还或者</p>
<pre><code class="hljs java">#!/bin/bash
A=`ps -C nginx –no-header |wc -l`
<span class="hljs-keyword">if</span> [ $A -eq <span class="hljs-number">0</span> ];then
 /usr/local/nginx/sbin/nginx
 sleep <span class="hljs-number">2</span>
 <span class="hljs-keyword">if</span> [ `ps -C nginx --no-header |wc -l` -eq <span class="hljs-number">0</span> ];then
 killall keepalived
 fi
fi</code></pre>
</li>
<li><p>将两台服务器上的nginx和keepalived都启动起来</p>
<p>启动keepalived：</p>
<pre><code class="hljs java">systemctl start keepalived.service</code></pre>

<p>查看是否启动</p>
<pre><code class="hljs java">ps -ef | grep keepalived</code></pre>




</li>
</ol>
<h2 id="高可用配置信息的详细解释"><a href="#高可用配置信息的详细解释" class="headerlink" title="高可用配置信息的详细解释"></a>高可用配置信息的详细解释</h2><p>全局配置</p>
<pre><code class="hljs java">global_defs &#123;
 notification_email &#123;
	 acassen<span class="hljs-meta">@firewall</span>.loc
	 failover<span class="hljs-meta">@firewall</span>.loc
	 sysadmin<span class="hljs-meta">@firewall</span>.loc
 &#125;
 notification_email_from Alexandre.Cassen<span class="hljs-meta">@firewall</span>.loc
 smtp_server <span class="hljs-number">192.168</span><span class="hljs-number">.56</span><span class="hljs-number">.102</span>
 smtp_connect_timeout <span class="hljs-number">30</span>
 router_id LVS_DEVEL	#访问到主机
&#125;</code></pre>

<p>检测脚本配置</p>
<pre><code class="hljs java">vrrp_script chk_http_port &#123;
 script <span class="hljs-string">"/usr/local/src/nginx_check.sh"</span>
 interval 2 #（检测脚本执行的间隔）
 weight <span class="hljs-number">2</span>
&#125;</code></pre>

<p>虚拟ip</p>
<pre><code class="hljs java">vrrp_instance VI_1 &#123;
 state BACKUP # 备份服务器上将 MASTER 改为 BACKUP
 <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">enp0s3</span> //网卡</span>
<span class="hljs-class"> <span class="hljs-title">virtual_router_id</span> 51 # 主、备机的 <span class="hljs-title">virtual_router_id</span> 必须相同</span>
<span class="hljs-class"> <span class="hljs-title">priority</span> 80 # 主、备机取不同的优先级，主机值较大，备份机值较小</span>
<span class="hljs-class"> <span class="hljs-title">advert_int</span> 1	#检查<span class="hljs-title">Nginx</span>是否还活着的间隔</span>
<span class="hljs-class"> <span class="hljs-title">authentication</span> </span>&#123;
 auth_type PASS
 auth_pass <span class="hljs-number">1111</span>
 &#125;
 virtual_ipaddress &#123;
 <span class="hljs-number">192.168</span><span class="hljs-number">.56</span><span class="hljs-number">.50</span> <span class="hljs-comment">// VRRP H 虚拟地址    可以绑定多个</span>
 &#125;
&#125;</code></pre>



<h2 id="Nginx原理"><a href="#Nginx原理" class="headerlink" title="Nginx原理"></a>Nginx原理</h2><p><img src="https://github.com/BunnyAndOak0/IMG/raw/master/images/Nginx/Nginx%E5%8E%9F%E7%90%86%E5%9B%BE.PNG" srcset="/img/loading.gif" alt="nginx原理图"></p>
<p>worker工作示示意图</p>
<p><img src="https://github.com/BunnyAndOak0/IMG/raw/master/images/Nginx/work%E5%B7%A5%E4%BD%9C%E7%A4%BA%E6%84%8F%E5%9B%BE.PNG" srcset="/img/loading.gif" alt="work工作示意图"></p>
<ol>
<li><p>一个master和多个worker的好处</p>
<ol>
<li>可以使用nginx    -s    reload进行热部署，利用nginx进行热部署操作</li>
<li>每个worerk都是独立的进程，其中一个出问题，其他work会继续争抢，不会出现服务中断的问题</li>
</ol>
</li>
<li><p>woker设置的数量</p>
<p>worker数和服务器的cpu数量相等最为合适</p>
</li>
<li><p>连接数</p>
<ol>
<li><p>发送一个一个请求，占用了worker的2~4个连接数，如果访问静态资源，则占用两个，使用tomcat等访问数据库，访问动态资源，就占用四个</p>
</li>
<li><p>普通静态资源访问的最大连接数：worker_connection * worker_processes / 2;</p>
<p>如果是HTTP作为反向代理，并发最大的数量应该是work_connectionns * worker_processes / 4。</p>
</li>
</ol>
</li>
</ol>
<hr>
<p>用到的知识点：</p>
<blockquote>
<p>ps -ef | grep tomcat                //查看进程</p>
<p>kill -9 XXX                             //停止进程    跟上id</p>
<p>:w保存文件但不退出vi 编辑</p>
<p>:w! 强制保存，不退出vi 编辑</p>
<p>:w file将修改另存到file中，不退出vi 编辑 </p>
<p>:wq保存文件并退出vi 编辑</p>
<p>:wq!强制保存文件并退出vi 编辑</p>
<p>q:不保存文件并退出vi 编辑</p>
<p>:q!不保存文件并强制退出vi 编辑</p>
<p>:e!放弃所有修改，从上次保存文件开始在编辑</p>
</blockquote>
<p><a href="https://www.bbsmax.com/A/6pdDbZ1OJw/" target="_blank" rel="noopener">关于克隆虚拟机 以便于集群的搭建</a></p>

            </article>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a href="https://zh.wikipedia.org/wiki/Wikipedia:CC_BY-SA_3.0%E5%8D%8F%E8%AE%AE%E6%96%87%E6%9C%AC" target="_blank" rel="nofollow noopener noopener">CC BY-SA 3.0协议</a> 。转载请注明出处！</p>
              
              
                <div class="post-prevnext row">
                  <div class="post-prev col-6">
                    
                    
                      <a href="/2020/06/18/servlet%E6%A2%B3%E7%90%86/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">servlet梳理</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </div>
                  <div class="post-next col-6">
                    
                    
                      <a href="/2020/06/16/PLSQL%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/">
                        <span class="hidden-mobile">PLSQL编程语言</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </div>
                </div>
              
            </div>

            
          </div>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p>
  <div id="tocbot"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    
  </main>

  
    <a id="scroll-top-button" href="#" role="button">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  

  <footer class="mt-5">
  <div class="text-center py-3">
    <div>
      <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a>
      <i class="iconfont icon-love"></i>
      <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener">
        <span>Fluid</span></a>
    </div>
    

    

    
  </div>
</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="/js/main.js" ></script>


  <script  src="/js/lazyload.js" ></script>



  
  <script  src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;

      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: '.post-content',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        collapseDepth: 0,
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc').css('visibility', 'visible');
      }
    });
  </script>





  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>
  <script  src="/js/clipboard-use.js" ></script>






<!-- Plugins -->



  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    var typed = new Typed('#subtitle', {
      strings: [
        '  ',
        "Nginx&nbsp;",
      ],
      cursorChar: "_",
      typeSpeed: 70,
      loop: false,
    });
    typed.stop();
    $(document).ready(function () {
      $(".typed-cursor").addClass("h2");
      typed.start();
    });
  </script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      searchFunc(path, 'local-search-input', 'local-search-result');
      this.onclick = null
    }
  </script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />

  <script>
    $('#post img:not(.no-zoom img, img[no-zoom]), img[zoom]').each(
      function () {
        var element = document.createElement('a');
        $(element).attr('data-fancybox', 'images');
        $(element).attr('href', $(this).attr('src'));
        $(this).wrap(element);
      }
    );
  </script>


















</body>
</html>
